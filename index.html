<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Performance, Forms, Commitments</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; margin: 20px; max-width: 650px; }
  .hidden { display: none; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  table, th, td { border: 1px solid #ccc; }
  th, td { padding: 8px; text-align: center; }
  .header-row { background: #f2f2f2; }
  .actions { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
  .metric-entry { margin-bottom: 12px; }
  .metric-entry label { display: block; font-weight: bold; margin-bottom: 4px; }
  .metric-entry input { margin-right: 6px; width: 120px; }
  select, input[type="text"], button { padding: 6px; margin-top: 4px; margin-bottom: 4px; }
</style>
<script src="hierarchy.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
<h1>Weekly Business Review</h1>

<!-- Selection Section -->
<div id="selectionSection">
  <form id="selectionForm">
    <label>Area:
      <select id="areaDropdown"><option value="">--Select Area--</option></select>
    </label>
    <label>Region:
      <select id="regionDropdown" disabled><option value="">--Select Region--</option></select>
    </label>
    <label>District:
      <select id="districtDropdown" disabled><option value="">--Select District--</option></select>
    </label>
    <label>Store:
      <select id="storeDropdown" disabled><option value="">--Select Store--</option></select>
    </label>
    <label>Week:
      <select id="weekSelect">
        <option value="">--Select Week--</option>
        <option value="week1">Week 1</option>
        <option value="week2">Week 2</option>
        <option value="week3">Week 3</option>
        <option value="week4">Week 4</option>
        <option value="week5">Week 5</option>
      </select>
    </label>
    <div class="actions"><button type="submit">Next</button></div>
  </form>
</div>

<!-- Metrics Entry Section -->
<div id="metricsSection" class="hidden">
  <form id="metricsForm">
    <div id="formMetrics"></div>
    <div class="actions">
      <button type="button" id="backButton">Back</button>
      <button type="button" id="saveMetricsBtn">Save Metrics</button>
      <button type="button" id="resetTargetsBtn">Reset Targets</button>
      <button type="button" id="goToTableBtn">Go to Table</button>
    </div>
  </form>
</div>

<!-- Table Section -->
<div id="tableSection" class="hidden">
  <div id="printMeta"></div>
  <h2 id="tableTitle">Metrics Table</h2>
  <table>
    <thead>
      <tr class="header-row">
        <th>Metric</th>
        <th>Targets</th>
        <th>Week 1</th>
        <th>Week 2</th>
        <th>Week 3</th>
        <th>Week 4</th>
        <th>Week 5</th>
      </tr>
    </thead>
    <tbody id="metricsTable"></tbody>
  </table>
  <div class="actions">
    <button id="backToMetrics">Back</button>
    <button id="clearAllData">Clear All Data</button>
    <button id="printTableBtn">Print</button>
  </div>
</div>

<script>
const defaultTargets = {
  "Net Trending GP":"", "Current Rank":"86", "Current Quintile":"1", "Bottom Metrics":"4th/5th",
  "GP % Target":"125%", "GP per HR":"$35", "Voice":"125%", "BTS":"125%", "TFB":"125%",
  "VAF":"$19", "Accessories":"125%", "CSAT":"9.5", "AAL Attainment":"125%"
};

let selectedArea="", selectedRegion="", selectedDistrict="", selectedStore="", selectedWeek="";
let allData = JSON.parse(localStorage.getItem("metricsData")) || {};

const areaDropdown = document.getElementById("areaDropdown"),
      regionDropdown = document.getElementById("regionDropdown"),
      districtDropdown = document.getElementById("districtDropdown"),
      storeDropdown = document.getElementById("storeDropdown"),
      weekSelect = document.getElementById("weekSelect"),
      selectionSection = document.getElementById("selectionSection"),
      metricsSection = document.getElementById("metricsSection"),
      tableSection = document.getElementById("tableSection"),
      formMetricsDiv = document.getElementById("formMetrics"),
      metricsTable = document.getElementById("metricsTable"),
      tableTitle = document.getElementById("tableTitle"),
      printMeta = document.getElementById("printMeta"),
      backButton = document.getElementById("backButton"),
      saveMetricsBtn = document.getElementById("saveMetricsBtn"),
      resetTargetsBtn = document.getElementById("resetTargetsBtn"),
      goToTableBtn = document.getElementById("goToTableBtn"),
      backToMetrics = document.getElementById("backToMetrics"),
      clearAllData = document.getElementById("clearAllData"),
      printTableBtn = document.getElementById("printTableBtn");

function populateAreaDropdown(){
  areaDropdown.innerHTML='<option value="">--Select Area--</option>';
  Object.keys(hierarchy).sort().forEach(area=>areaDropdown.innerHTML+=`<option value="${area}">${area}</option>`);
  regionDropdown.disabled=true; districtDropdown.disabled=true; storeDropdown.disabled=true;
}
areaDropdown.addEventListener('change',()=>{
  selectedArea=areaDropdown.value;
  regionDropdown.disabled=!selectedArea; districtDropdown.disabled=true; storeDropdown.disabled=true;
  regionDropdown.innerHTML='<option value="">--Select Region--</option>';
  districtDropdown.innerHTML='<option value="">--Select District--</option>';
  storeDropdown.innerHTML='<option value="">--Select Store--</option>';
  if(!selectedArea)return;
  Object.keys(hierarchy[selectedArea]).sort().forEach(region=>regionDropdown.innerHTML+=`<option value="${region}">${region}</option>`);
});
regionDropdown.addEventListener('change',()=>{
  selectedRegion=regionDropdown.value;
  districtDropdown.disabled=!selectedRegion; storeDropdown.disabled=true;
  districtDropdown.innerHTML='<option value="">--Select District--</option>';
  storeDropdown.innerHTML='<option value="">--Select Store--</option>';
  if(!selectedRegion)return;
  Object.keys(hierarchy[selectedArea][selectedRegion]).sort().forEach(district=>districtDropdown.innerHTML+=`<option value="${district}">${district}</option>`);
});
districtDropdown.addEventListener('change',()=>{
  selectedDistrict=districtDropdown.value; storeDropdown.disabled=!selectedDistrict; storeDropdown.innerHTML='<option value="">--Select Store--</option>';
  if(!selectedDistrict)return;
  hierarchy[selectedArea][selectedRegion][selectedDistrict].sort().forEach(store=>storeDropdown.innerHTML+=`<option value="${store}">${store}</option>`);
});
storeDropdown.addEventListener('change',()=>{selectedStore=storeDropdown.value;});

// Build metric form
function buildForm(){
  formMetricsDiv.innerHTML='';
  if(!allData[selectedStore]) allData[selectedStore]={};
  if(!allData[selectedStore][selectedWeek]) allData[selectedStore][selectedWeek]={targets:{},metrics:{}};
  let targets = allData[selectedStore][selectedWeek].targets || {...defaultTargets};
  for(let metric in defaultTargets){
    let value = allData[selectedStore][selectedWeek].metrics?.[metric] || "";
    let div=document.createElement("div");
    div.className="metric-entry";
    div.innerHTML=`<label>${metric}</label>
                   Target: <input type="text" name="target-${metric}" value="${targets[metric]}"/>
                   Current: <input type="text" name="current-${metric}" value="${value}"/>`;
    formMetricsDiv.appendChild(div);
  }
}

// Save metrics and targets
function saveMetrics(){
  if(!allData[selectedStore]) allData[selectedStore]={};
  if(!allData[selectedStore][selectedWeek]) allData[selectedStore][selectedWeek]={targets:{},metrics:{}};
  let weekObj = allData[selectedStore][selectedWeek];
  weekObj.targets = {}; weekObj.metrics = {};
  for(let metric in defaultTargets){
    weekObj.targets[metric]=document.querySelector(`[name="target-${metric}"]`).value;
    weekObj.metrics[metric]=document.querySelector(`[name="current-${metric}"]`).value;
  }
  localStorage.setItem("metricsData",JSON.stringify(allData));
  buildTable();
}

// Reset targets to defaults
function resetTargets(){
  for(let metric in defaultTargets){
    document.querySelector(`[name="target-${metric}"]`).value=defaultTargets[metric];
  }
  saveMetrics();
}

// Build table
function buildTable(){
  if(!allData[selectedStore]) allData[selectedStore]={};
  let weekObj = allData[selectedStore];
  metricsTable.innerHTML='';
  tableTitle.textContent=`Store: ${selectedStore}`;
  let now=new Date();
  printMeta.textContent=`Area: ${selectedArea} | Region: ${selectedRegion} | District: ${selectedDistrict} | Store: ${selectedStore} | Printed: ${now.toLocaleString()}`;
  for(let metric in defaultTargets){
    let row=document.createElement("tr");
    row.innerHTML=`<td>${metric}</td>
      <td>${allData[selectedStore][selectedWeek]?.targets?.[metric] || defaultTargets[metric]}</td>
      <td>${weekObj.week1?.metrics?.[metric]||""}</td>
      <td>${weekObj.week2?.metrics?.[metric]||""}</td>
      <td>${weekObj.week3?.metrics?.[metric]||""}</td>
      <td>${weekObj.week4?.metrics?.[metric]||""}</td>
      <td>${weekObj.week5?.metrics?.[metric]||""}</td>`;
    metricsTable.appendChild(row);
  }
}

// Navigation
document.getElementById("selectionForm").addEventListener('submit',e=>{
  e.preventDefault();
  selectedArea=areaDropdown.value; selectedRegion=regionDropdown.value; selectedDistrict=districtDropdown.value; selectedStore=storeDropdown.value; selectedWeek=weekSelect.value;
  if(!selectedArea||!selectedRegion||!selectedDistrict||!selectedStore||!selectedWeek) return;
  buildForm(); selectionSection.classList.add("hidden"); metricsSection.classList.remove("hidden"); tableSection.classList.add("hidden");
});
backButton.onclick=()=>{selectionSection.classList.remove("hidden"); metricsSection.classList.add("hidden"); tableSection.classList.add("hidden");};
saveMetricsBtn.onclick=saveMetrics;
resetTargetsBtn.onclick=resetTargets;
goToTableBtn.onclick=()=>{metricsSection.classList.add("hidden"); tableSection.classList.remove("hidden"); buildTable();};
backToMetrics.onclick=()=>{tableSection.classList.add("hidden"); metricsSection.classList.remove("hidden");};
clearAllData.onclick=()=>{
  if(selectedStore && confirm("Clear all saved data for this store?")){delete allData[selectedStore]; localStorage.setItem("metricsData",JSON.stringify(allData)); buildTable();}
};
printTableBtn.onclick=()=>{html2canvas(tableSection).then(canvas=>{let win=window.open('','_blank'); win.document.body.style.margin="0"; win.document.body.appendChild(canvas); setTimeout(()=>{win.print();},500);});};

populateAreaDropdown();
</script>
</body>
</html>
